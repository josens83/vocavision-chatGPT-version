// Prisma Schema for VocaVision

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// User Management
// ============================================

model User {
  id            String    @id @default(uuid())
  email         String?   @unique
  password      String?
  name          String?
  avatar        String?
  role          UserRole  @default(USER)

  // OAuth
  kakaoId       String?   @unique
  provider      String    @default("local") // local, kakao, google

  // Subscription
  subscriptionStatus SubscriptionStatus @default(FREE)
  subscriptionId     String?
  subscriptionPlan   SubscriptionPlan?
  subscriptionStart  DateTime?
  subscriptionEnd    DateTime?
  trialEnd          DateTime?

  // Learning Stats
  totalWordsLearned Int @default(0)
  currentStreak     Int @default(0)
  longestStreak     Int @default(0)
  lastActiveDate    DateTime?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Daily Goals
  dailyGoal     Int       @default(10) // Daily word goal
  dailyProgress Int       @default(0)  // Words studied today
  lastGoalReset DateTime?

  // Relations
  progress      UserProgress[]
  reviews       Review[]
  customMnemonics CustomMnemonic[]
  studySessions StudySession[]
  achievements  UserAchievement[]
  bookmarks     Bookmark[]
  notifications Notification[]
  decks         Deck[]
  leagueMemberships LeagueMembership[]
  purchases     UserPurchase[]

  // Notification Preferences
  emailNotifications    Boolean @default(true)
  pushNotifications     Boolean @default(true)
  reminderTime          String  @default("09:00") // HH:mm format
  reminderDays          String  @default("1,2,3,4,5,6,7") // Days of week (1=Mon, 7=Sun)

  @@index([email])
}

enum UserRole {
  USER
  ADMIN
  MODERATOR
}

enum SubscriptionStatus {
  FREE
  TRIAL
  ACTIVE
  CANCELLED
  EXPIRED
}

enum SubscriptionPlan {
  MONTHLY
  YEARLY
  FAMILY
}

// ============================================
// Vocabulary
// ============================================

model Word {
  id          String   @id @default(uuid())
  word        String
  wordType    WordType @default(WORD)  // 단어/구문 타입
  definition  String
  definitionKo String?  // 한국어 뜻
  pronunciation String?
  phonetic    String?
  partOfSpeech PartOfSpeech
  difficulty  DifficultyLevel @default(INTERMEDIATE)
  cefrLevel   CEFRLevel?      // CEFR 레벨 (A1-C2)
  examCategory ExamCategory   // 기본 시험 카테고리 (하위 호환용)
  level       String?         // 기본 레벨 (L1, L2, L3 등)
  frequency   Int      @default(0) // Word frequency ranking
  tags        String[] // 의미/주제 태그 (일반, 과학, 심리 등)

  // Additional learning content
  tips        String?  // 학습 팁
  commonMistakes String? // 흔한 실수

  // ===== 발음 (Pronunciation) - 확장 =====
  ipaUs       String?  // /ˈæp.əl/ 미국식 IPA
  ipaUk       String?  // 영국식 IPA
  audioUrlUs  String?  // 미국식 발음 오디오 URL
  audioUrlUk  String?  // 영국식 발음 오디오 URL

  // ===== 형태 분석 (Morphology) =====
  prefix      String?  // 접두사 "un-", "re-"
  root        String?  // 어근 "port" (나르다)
  suffix      String?  // 접미사 "-tion", "-ly"
  morphologyNote String? // 형태 분석 설명

  // ===== 관련어 배열 (빠른 조회용) =====
  synonymList    String[] // 동의어 배열
  antonymList    String[] // 반의어 배열
  rhymingWords   String[] // 라이밍 단어 배열
  relatedWords   String[] // 관련어 배열

  // ===== 콘텐츠 상태 (Admin) =====
  status      ContentStatus @default(DRAFT)
  isActive    Boolean       @default(true)
  publishedAt DateTime?

  // ===== AI 생성 메타데이터 =====
  aiModel         String?   // "claude-sonnet-4-20250514" 등
  aiGeneratedAt   DateTime? // AI 생성 시각
  aiPromptVersion String?   // 사용된 프롬프트 버전
  humanReviewed   Boolean   @default(false)
  reviewedBy      String?   // 검토자 ID
  reviewedAt      DateTime?
  reviewNotes     String?   // 검토 노트

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  examples    Example[]
  images      WordImage[]
  visuals     WordVisual[]   // 3-이미지 시각화 시스템
  videos      WordVideo[]
  rhymes      Rhyme[]
  mnemonics   Mnemonic[]
  etymology   Etymology?
  synonyms    Synonym[]
  antonyms    Antonym[]
  collocations Collocation[]
  progress    UserProgress[]
  examLevels  WordExamLevel[]  // 다중 시험/레벨 매핑
  productPackages ProductPackageWord[]  // 단품 상품 매핑

  @@unique([word, examCategory])  // 같은 단어를 여러 시험에 추가 가능
  @@index([word])
  @@index([difficulty])
  @@index([cefrLevel])
  @@index([examCategory])
  @@index([frequency])
  @@index([level])
  @@index([status])
}

// 단어-시험-레벨 매핑 테이블 (다중 시험 지원)
// 예: "abandon"이 CSAT-L1, TEPS-L2에 동시에 속할 수 있음
model WordExamLevel {
  id           String        @id @default(uuid())
  wordId       String
  examCategory ExamCategory
  level        String        // L1, L2, L3
  frequency    Int           @default(0)  // 시험별 빈도
  status       ContentStatus @default(DRAFT)  // 시험별 발행 상태

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  word         Word          @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@unique([wordId, examCategory])  // 단어당 시험은 하나의 레벨만
  @@index([wordId])
  @@index([examCategory])
  @@index([level])
  @@index([status])
  @@index([examCategory, level])
  @@index([examCategory, status])
}

enum PartOfSpeech {
  NOUN
  VERB
  ADJECTIVE
  ADVERB
  PRONOUN
  PREPOSITION
  CONJUNCTION
  INTERJECTION
}

enum DifficultyLevel {
  BASIC
  INTERMEDIATE
  ADVANCED
}

// CEFR Level (유럽공통참조기준)
enum CEFRLevel {
  A1   // Elementary
  A2   // Pre-intermediate
  B1   // Intermediate
  B2   // Upper-intermediate
  C1   // Advanced
  C2   // Proficiency
}

// Content Status for Admin workflow
enum ContentStatus {
  DRAFT           // 초안 - AI 생성 직후
  PENDING_REVIEW  // 검토 대기
  APPROVED        // 승인됨 - 발행 가능
  PUBLISHED       // 발행됨
  ARCHIVED        // 보관됨
}

// Exam Categories for Korean users
enum ExamCategory {
  CSAT        // 수능 (대학수학능력시험) - 고급 어휘
  CSAT_BASIC  // 수능 기초 (중학 필수 어휘)
  TEPS        // 텝스 (서울대 영어능력시험)
  TOEIC       // 토익 (비즈니스 영어)
  TOEFL       // 토플 (학술 영어)
  SAT         // SAT (미국 대입)
}

// 단어/구문 타입 (Word Pool 구분용)
enum WordType {
  WORD          // 단일 단어: abandon, ubiquitous
  PHRASE        // 구문: a biting cold, break the news
  IDIOM         // 숙어: rain cats and dogs, be all thumbs
  PHRASAL_VERB  // 구동사: break into, carry on, give off
  COLLOCATION   // 연어: make a decision, take a shower
}

// ============================================
// Learning Methods
// ============================================

// 1. Examples
model Example {
  id        String   @id @default(uuid())
  wordId    String
  sentence  String
  translation String? // 한국어 번역
  audioUrl  String?

  // ===== 예문 분류 (Content Pipeline) =====
  isFunny       Boolean  @default(false)  // 재미있는 예문 여부
  isReal        Boolean  @default(true)   // 실제 사용 예문 vs 학습용
  source        String?  // 출처 (영화, 드라마, 뉴스 등)
  highlightWord String?  // 강조할 단어
  grammarNote   String?  // 문법 설명
  order         Int      @default(0)  // 정렬 순서

  createdAt DateTime @default(now())

  word      Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@index([wordId])
}

// 2. Images
model WordImage {
  id          String   @id @default(uuid())
  wordId      String
  imageUrl    String
  thumbnailUrl String?
  description String?
  source      ImageSource @default(AI_GENERATED)
  aiPrompt    String?  // AI 생성 이미지의 프롬프트

  createdAt   DateTime @default(now())

  word        Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@index([wordId])
}

enum ImageSource {
  AI_GENERATED
  STOCK_PHOTO
  ILLUSTRATION
  USER_UPLOADED
}

// ===== 3-이미지 시각화 시스템 (VocaVision 핵심 기능) =====
// 각 단어마다 3가지 이미지로 시각화
// - Concept (의미): 단어 의미를 직관적으로 보여주는 이미지
// - Mnemonic (연상): 한국어식 연상법에 맞는 이미지
// - Rhyme (라이밍): 발음/라이밍 기반 상황 이미지
model WordVisual {
  id          String      @id @default(uuid())
  wordId      String
  type        VisualType

  // 라벨 (탭 표시용)
  labelEn     String?     // "Concept", "Mnemonic", "Rhyme"
  labelKo     String?     // "의미", "연상", "라이밍"

  // 캡션 (이미지 설명)
  captionEn   String?     // 영어 캡션
  captionKo   String?     // 한국어 캡션 (학습자용)

  // 이미지 URL (정적 이미지 또는 GIF)
  imageUrl    String?     // Cloudinary URL (GIF 지원)

  // AI 이미지 생성 프롬프트
  promptEn    String?     @db.Text  // DALL-E/Midjourney 프롬프트

  // 정렬 순서
  order       Int         @default(0)

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  word        Word        @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@unique([wordId, type])
  @@index([wordId])
}

enum VisualType {
  CONCEPT    // 의미 시각화 (dormant → 휴화산)
  MNEMONIC   // 연상법 이미지 (dormant → doorman이 졸고 있음)
  RHYME      // 라이밍 이미지 (daunting to dormant man)
}

// 3. Videos/Animations
model WordVideo {
  id          String   @id @default(uuid())
  wordId      String
  videoUrl    String
  thumbnailUrl String?
  duration    Int?     // Duration in seconds
  type        VideoType @default(ANIMATION)
  description String?

  createdAt   DateTime @default(now())

  word        Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@index([wordId])
}

enum VideoType {
  ANIMATION
  LIVE_ACTION
  WHITEBOARD
  MOTION_GRAPHICS
}

// 4. Rhyming
model Rhyme {
  id          String   @id @default(uuid())
  wordId      String
  rhymingWord String
  similarity  Float    // 0.0 ~ 1.0 (유사도)
  example     String?  // 예문으로 함께 사용

  word        Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@index([wordId])
}

// 5. Mnemonics (연상법)
model Mnemonic {
  id          String   @id @default(uuid())
  wordId      String
  title       String
  content     String
  koreanHint  String?  // 한국어 연상 힌트 (경선식 스타일)
  imageUrl    String?  // 연상 이미지 URL
  source      MnemonicSource @default(AI_GENERATED)
  rating      Float    @default(0)
  ratingCount Int      @default(0)

  // ===== WHISK 이미지 생성 (Content Pipeline) =====
  whiskPrompt String?  // WHISK 이미지 생성 프롬프트
  whiskStyle  String?  // "animation", "illustration"
  gifUrl      String?  // WHISK 생성 GIF URL

  createdAt   DateTime @default(now())

  word        Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@index([wordId])
  @@index([rating])
}

enum MnemonicSource {
  AI_GENERATED
  EXPERT_CREATED
  COMMUNITY
}

// User-created mnemonics
model CustomMnemonic {
  id        String   @id @default(uuid())
  userId    String
  wordId    String
  content   String
  isPrivate Boolean  @default(false)

  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([wordId])
}

// 6. Etymology (어원)
model Etymology {
  id          String   @id @default(uuid())
  wordId      String   @unique
  origin      String
  language    String?  // 어원 언어 (Latin, Greek, French, Germanic 등)
  rootWords   String[] // Array of root words
  evolution   String   // 단어의 발전 과정
  relatedWords String[] // 같은 어원을 가진 단어들
  breakdown   String?  // 어원 분해 설명

  createdAt   DateTime @default(now())

  word        Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)
}

// 7. Synonyms & Antonyms
model Synonym {
  id        String   @id @default(uuid())
  wordId    String
  synonym   String
  nuance    String?  // 뉘앙스 차이 설명

  word      Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@index([wordId])
}

model Antonym {
  id        String   @id @default(uuid())
  wordId    String
  antonym   String
  explanation String?

  word      Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@index([wordId])
}

// 8. Collocations (콜로케이션)
model Collocation {
  id          String   @id @default(uuid())
  wordId      String
  phrase      String   // "make a decision"
  translation String?  // "결정을 내리다"
  exampleEn   String?  // 예문 (영어)
  exampleKo   String?  // 예문 (한국어)
  type        String?  // "verb+noun", "adj+noun", "adv+adj"
  frequency   Int      @default(0)  // 사용 빈도
  order       Int      @default(0)

  createdAt   DateTime @default(now())

  word        Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@index([wordId])
}

// ============================================
// Learning Progress & Spaced Repetition
// ============================================

model UserProgress {
  id              String   @id @default(uuid())
  userId          String
  wordId          String

  // Spaced Repetition (SM-2 Algorithm)
  easeFactor      Float    @default(2.5)
  interval        Int      @default(1)  // Days until next review
  repetitions     Int      @default(0)
  nextReviewDate  DateTime
  lastReviewDate  DateTime?

  // Progress
  masteryLevel    MasteryLevel @default(NEW)
  correctCount    Int      @default(0)
  incorrectCount  Int      @default(0)
  totalReviews    Int      @default(0)

  // Learning methods used
  usedImages      Boolean  @default(false)
  usedVideos      Boolean  @default(false)
  usedRhymes      Boolean  @default(false)
  usedMnemonics   Boolean  @default(false)
  usedEtymology   Boolean  @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  word            Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@unique([userId, wordId])
  @@index([userId])
  @@index([nextReviewDate])
}

enum MasteryLevel {
  NEW
  LEARNING
  FAMILIAR
  MASTERED
}

// ============================================
// Study Sessions & Reviews
// ============================================

model StudySession {
  id            String   @id @default(uuid())
  userId        String
  startTime     DateTime @default(now())
  endTime       DateTime?
  duration      Int?     // Duration in seconds
  wordsStudied  Int      @default(0)
  wordsCorrect  Int      @default(0)

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviews       Review[]

  @@index([userId])
  @@index([startTime])
}

model Review {
  id              String   @id @default(uuid())
  userId          String
  wordId          String
  sessionId       String?

  rating          Int      // 1-5 (1: Again, 2: Hard, 3: Good, 4: Easy, 5: Perfect)
  responseTime    Int?     // Response time in milliseconds
  learningMethod  LearningMethod

  createdAt       DateTime @default(now())

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  session         StudySession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([sessionId])
}

enum LearningMethod {
  FLASHCARD
  IMAGE
  VIDEO
  RHYME
  MNEMONIC
  ETYMOLOGY
  QUIZ
  WRITING
  INTERACTIVE_DOC  // n8n-style interactive documentation
}

// ============================================
// Gamification & Achievements
// ============================================

model Achievement {
  id          String   @id @default(uuid())
  name        String
  description String
  icon        String
  requirement Int      // Required value to unlock
  type        AchievementType

  users       UserAchievement[]
}

enum AchievementType {
  WORDS_LEARNED
  DAILY_STREAK
  PERFECT_REVIEWS
  METHODS_USED
  STUDY_TIME
}

model UserAchievement {
  id            String   @id @default(uuid())
  userId        String
  achievementId String
  unlockedAt    DateTime @default(now())

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
}

// ============================================
// Content Collections
// ============================================

model Collection {
  id          String   @id @default(uuid())
  name        String
  slug        String?  @unique // URL-friendly identifier (e.g., "csat-starter-100")
  description String?
  icon        String?
  category    String
  difficulty  DifficultyLevel
  isPublic    Boolean  @default(true)

  wordIds     String[] // Array of word IDs

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([difficulty])
  @@index([slug])
}

// ============================================
// Custom Decks (Anki-style)
// ============================================

model Deck {
  id          String   @id @default(uuid())
  name        String
  description String?
  userId      String
  isPublic    Boolean  @default(false)
  tags        String[] // Array of tags
  wordIds     String[] // Array of word IDs

  // Cloning info
  clonedFromId String?
  cloneCount   Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isPublic])
}

// ============================================
// Bookmarks & Favorites
// ============================================

model Bookmark {
  id        String   @id @default(uuid())
  userId    String
  wordId    String
  notes     String?  // Personal notes
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, wordId])
  @@index([userId])
  @@index([wordId])
}

// ============================================
// Notifications
// ============================================

model Notification {
  id          String   @id @default(uuid())
  userId      String
  type        NotificationType
  title       String
  message     String
  data        String?  // JSON data for additional context
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([isRead])
}

enum NotificationType {
  REVIEW_REMINDER    // Time to review words
  STREAK_WARNING     // About to lose streak
  STREAK_ACHIEVED    // Reached a streak milestone
  ACHIEVEMENT_UNLOCK // New achievement unlocked
  GOAL_COMPLETED     // Daily goal completed
  GOAL_REMINDER      // Reminder to complete daily goal
  WEEKLY_SUMMARY     // Weekly progress summary
  NEW_WORDS          // New words available
}

// ============================================
// Interactive Documentation Progress
// ============================================

model InteractiveDocProgress {
  id              String   @id @default(uuid())
  userId          String
  wordId          String
  stepId          String   // Step identifier (step-introduction, step-visualization, etc.)
  stepNumber      Int      // 1-5

  // Progress tracking
  started         Boolean  @default(false)
  completed       Boolean  @default(false)
  timeSpent       Int      @default(0)  // Total time spent in seconds
  interactions    Int      @default(0)  // Number of user interactions
  score           Float?   // Quiz/exercise score (0-100)

  // Timestamps
  startedAt       DateTime?
  completedAt     DateTime?
  lastInteraction DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([userId, wordId, stepId])
  @@index([userId])
  @@index([wordId])
  @@index([userId, wordId])
  @@index([completed])
}

// Word completion tracking for interactive docs
model InteractiveDocCompletion {
  id              String   @id @default(uuid())
  userId          String
  wordId          String

  // Completion stats
  stepsCompleted  Int      @default(0)  // Number of steps completed (0-5)
  totalSteps      Int      @default(5)  // Total number of steps
  totalTimeSpent  Int      @default(0)  // Total time spent in seconds
  averageScore    Float?   // Average quiz/exercise score
  completionRate  Float    @default(0)  // Percentage (0-100)

  // Status
  isCompleted     Boolean  @default(false)
  completedAt     DateTime?
  lastAccessedAt  DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([userId, wordId])
  @@index([userId])
  @@index([wordId])
  @@index([isCompleted])
}

// ============================================
// League System (Duolingo-style)
// ============================================

enum LeagueTier {
  BRONZE
  SILVER
  GOLD
  SAPPHIRE
  RUBY
  EMERALD
  AMETHYST
  PEARL
  OBSIDIAN
  DIAMOND
}

model League {
  id            String      @id @default(uuid())
  tier          LeagueTier
  weekStart     DateTime    // Monday of the week
  weekEnd       DateTime    // Sunday of the week

  // Zone settings
  promotionZone Int         @default(10)  // Top N get promoted
  demotionZone  Int         @default(5)   // Bottom N get demoted

  createdAt     DateTime    @default(now())

  memberships   LeagueMembership[]

  @@unique([tier, weekStart])
  @@index([tier])
  @@index([weekStart])
}

model LeagueMembership {
  id          String      @id @default(uuid())
  userId      String
  leagueId    String

  // XP earned this week
  weeklyXP    Int         @default(0)

  // Final rank at end of week (null until week ends)
  finalRank   Int?

  // Result (after week ends)
  result      LeagueResult?

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  league      League      @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  @@unique([userId, leagueId])
  @@index([userId])
  @@index([leagueId])
  @@index([weeklyXP])
}

enum LeagueResult {
  PROMOTED
  STAYED
  DEMOTED
}

// ============================================
// Learning Records (퀴즈/학습 기록)
// ============================================

model LearningRecord {
  id              String   @id @default(uuid())
  userId          String
  wordId          String

  // 퀴즈 타입
  quizType        QuizType

  // 결과
  isCorrect       Boolean
  selectedAnswer  String?   // 선택한 답
  correctAnswer   String?   // 정답

  // 시간
  responseTime    Int?      // 응답 시간 (ms)

  // 세션 정보
  sessionId       String?   // 세션 그룹화용

  createdAt       DateTime  @default(now())

  @@index([userId])
  @@index([userId, createdAt])
  @@index([userId, quizType])
  @@index([sessionId])
}

enum QuizType {
  LEVEL_TEST      // 레벨 테스트
  ENG_TO_KOR      // 영→한 퀴즈
  KOR_TO_ENG      // 한→영 퀴즈
  FLASHCARD       // 플래시카드
  SPELLING        // 스펠링
}

// ============================================
// Content Pipeline - AI 생성 작업 관리
// ============================================

// AI 생성 작업 큐 (배치 처리용)
model ContentGenerationJob {
  id            String      @id @default(uuid())

  // 작업 대상
  wordId        String?     // 단일 단어 ID
  batchId       String?     // 배치 작업 그룹 ID
  inputWords    String[]    // 배치 처리할 단어들

  // 작업 상태
  status        String      @default("pending")  // pending, processing, completed, failed
  progress      Int         @default(0)          // 0-100 진행률

  // 생성 설정
  generateFields String[]   // ["etymology", "mnemonic", "examples"] 생성할 필드
  examCategory  ExamCategory?
  cefrLevel     CEFRLevel?
  aiModel       String      @default("claude-sonnet-4-20250514")

  // 결과
  result        Json?       // 생성된 콘텐츠 JSON
  errorMessage  String?
  retryCount    Int         @default(0)

  // 요청자
  requestedById String?

  startedAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime    @default(now())

  @@index([status])
  @@index([batchId])
  @@index([createdAt])
}

// 콘텐츠 변경 이력 (Audit Log)
model ContentAuditLog {
  id            String      @id @default(uuid())

  entityType    String      // "Word", "Example", "Mnemonic"
  entityId      String
  action        String      // "create", "update", "delete", "publish", "review"

  previousData  Json?       // 변경 전 데이터
  newData       Json?       // 변경 후 데이터
  changedFields String[]    // 변경된 필드명들

  performedById String?     // 수행자 ID
  performedAt   DateTime    @default(now())
  ipAddress     String?
  userAgent     String?

  @@index([entityType, entityId])
  @@index([performedAt])
  @@index([performedById])
}

// ============================================
// Payments (토스페이먼츠)
// ============================================

model Payment {
  id            String        @id @default(uuid())
  userId        String

  // 주문 정보
  orderId       String        @unique  // 고유 주문 ID
  orderName     String                 // 주문명 (예: "VocaVision 베이직 월간 구독")

  // 금액
  amount        Int                    // 결제 금액 (원)

  // 토스페이먼츠 정보
  paymentKey    String?       @unique  // 토스페이먼츠 결제키
  method        String?                // 결제 수단 (카드, 간편결제 등)

  // 상태
  status        PaymentStatus @default(PENDING)

  // 플랜 정보
  plan          String                 // 'basic', 'premium'
  billingCycle  String                 // 'monthly', 'yearly'

  // 빌링키 (정기결제용)
  billingKey    String?                // 암호화된 빌링키
  customerKey   String?                // 고객 식별키

  // 에러 정보
  failReason    String?

  // 타임스탬프
  paidAt        DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  purchase      UserPurchase?

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

enum PaymentStatus {
  PENDING       // 결제 대기
  COMPLETED     // 결제 완료
  FAILED        // 결제 실패
  CANCELLED     // 결제 취소
  REFUNDED      // 환불됨
}

// ============================================
// Product Packages (단품 상품)
// ============================================

model ProductPackage {
  id            String    @id @default(uuid())

  // 상품 정보
  name          String                 // "TEPS 최다 빈출 100"
  slug          String    @unique      // "teps-top-100" (URL용)
  description   String?                // 상품 설명
  shortDesc     String?                // 카드에 표시할 짧은 설명

  // 가격
  price         Int                    // 가격 (원)
  originalPrice Int?                   // 정가 (할인 전, 할인 표시용)

  // 이용 기간
  durationDays  Int                    // 이용 기간 (일) - 예: 365

  // 표시 정보
  badge         String?                // "BEST", "NEW", "EVENT"
  badgeColor    String?                // 배지 색상
  imageUrl      String?                // 상품 이미지
  displayOrder  Int       @default(0)  // 표시 순서

  // 상태
  isActive      Boolean   @default(true)
  isComingSoon  Boolean   @default(false)

  // 타임스탬프
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  words         ProductPackageWord[]
  purchases     UserPurchase[]

  @@index([isActive])
  @@index([displayOrder])
}

model ProductPackageWord {
  id          String    @id @default(uuid())
  packageId   String
  wordId      String
  displayOrder Int      @default(0)  // 단어 표시 순서

  createdAt   DateTime  @default(now())

  // Relations
  package     ProductPackage @relation(fields: [packageId], references: [id], onDelete: Cascade)
  word        Word           @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@unique([packageId, wordId])
  @@index([packageId])
  @@index([wordId])
}

model UserPurchase {
  id            String    @id @default(uuid())
  visibleId     String    @unique @default(cuid())  // 사용자에게 표시되는 주문번호

  userId        String
  packageId     String

  // 결제 정보
  paymentId     String?   @unique  // Payment 테이블 연결
  amount        Int                 // 결제 금액

  // 이용 기간
  purchasedAt   DateTime  @default(now())
  expiresAt     DateTime            // 만료일

  // 상태
  status        PurchaseStatus @default(ACTIVE)

  // 타임스탬프
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  package       ProductPackage @relation(fields: [packageId], references: [id])
  payment       Payment?       @relation(fields: [paymentId], references: [id])

  @@index([userId])
  @@index([packageId])
  @@index([expiresAt])
  @@index([status])
}

enum PurchaseStatus {
  ACTIVE        // 이용 중
  EXPIRED       // 만료됨
  REFUNDED      // 환불됨
}
